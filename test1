#include <signal.h> //Signal 사용 헤더파일
#include <unistd.h>
#include <stdio.h> 
#include <string.h> 
#include <errno.h>
#include <stdlib.h> //exit() 사용 헤더파일

#include <pthread.h>
#include <wiringPi.h>

#define MAX_THREAD 4

#define PUMP	21 // BCM_GPIO 5
#define FAN	22 // BCM_GPIO 6
#define LEDBAR	26 // BCM_GPIO 12
#define BUZCONTROL  28	//GPIO 20

#define RGBLEDPOWER  24 //BCM_GPIO 19

#define RED		7 //27
#define GREEN	8 //28
#define BLUE	9 //29

void *pump_light_func(void *vargp);
void *fan_func(void *vargp);
void *motion_func(void *vargp);
//int *tem_hum_func(void *vargp);

void sig_handler(int signo);  // 마지막 종료 함수

int main(void)
{
	pthread_t tid;
	int i;

	pthread_create(&thread_id[0], NULL, pump_light_func, NULL);
	pthread_create(&thread_id[1], NULL, fan_func, NULL);
	pthread_create(&thread_id[2], NULL, motion_func, NULL);
	//pthread_create(&thread_id[3], NULL, tem_hum_func, NULL);

	for (i = 0; i < MAX_THREAD; i++)
	{
		pthread_join(thread_id[i], NULL);
	}

	return 0;
}

void *pump_light_func(void *vargp)
{
	signal(SIGINT, (void*)sig_handler);	//시그널 핸들러 함수

	if (wiringPiSetup() == -1)
	{
		fprintf(stdout, "Unable to start wiringPi: %s\n", strerror(errno));
		return 1;
	}

	pinMode(PUMP, OUTPUT);

	for (;;)
	{
		printf("here - pump on\n");
		digitalWrite(PUMP, 1); // On

		delay(2000); // ms

		digitalWrite(PUMP, 0); // Off

		delay(2000);

	}
	return 0;
}

void sig_handler(int signo)
{
	printf("process stop\n");
	digitalWrite(PUMP, 0); // Off

	exit(0);
}
